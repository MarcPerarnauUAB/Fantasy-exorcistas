<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fantasy Colegas - App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .btn-activo { background-color: #1e40af; border-bottom: 4px solid #60a5fa; }
      .bg-cesped { background-color: #15803d; background-image: repeating-linear-gradient(0deg, transparent, transparent 19px, #166534 20px); }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      .mercado-cerrado { opacity: 0.6; pointer-events: none; filter: grayscale(0.8); }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen font-sans">
    
    <nav class="bg-gray-900 text-white shadow-lg sticky top-0 z-50">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center gap-2">
            <span class="text-2xl">‚öΩ</span>
            <span class="font-bold text-xl tracking-tight">Exorcistas</span>
          </div>
          <div class="hidden md:flex space-x-1 h-full">
            <button onclick="cambiarPesta√±a('plantilla')" id="tab-plantilla" class="px-3 hover:bg-gray-800 h-full flex items-center transition">üëï Mi Plantilla</button>
            <button onclick="cambiarPesta√±a('mercado')" id="tab-mercado" class="px-3 hover:bg-gray-800 h-full flex items-center transition">üí∞ Mercado</button>
            <button onclick="cambiarPesta√±a('clasificacion')" id="tab-clasificacion" class="px-3 hover:bg-gray-800 h-full flex items-center transition btn-activo">üèÜ Clasificaci√≥n</button>
            <button onclick="cambiarPesta√±a('calendario')" id="tab-calendario" class="px-3 hover:bg-gray-800 h-full flex items-center transition">üìÖ Liga</button>
            <button onclick="cambiarPesta√±a('estadisticas')" id="tab-estadisticas" class="px-3 hover:bg-gray-800 h-full flex items-center transition">üìä Estad√≠sticas</button>
          </div>
          <div class="flex items-center gap-4">
            <button id="btn-admin-recalc" onclick="recalcularTodo()" class="hidden text-xs bg-purple-600 hover:bg-purple-700 text-white font-bold px-3 py-1 rounded transition shadow-lg border border-purple-800 flex items-center gap-1">üîÑ Recalcular</button>
            <button id="btn-admin-puntos" onclick="abrirGestorPuntos()" class="hidden text-sm bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-3 py-1 rounded transition shadow-lg border border-yellow-600 flex items-center gap-1">‚öΩ √Årbitro</button>
            <span id="user-email" class="text-xs text-gray-400 hidden sm:block">...</span>
            <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 px-3 py-1 rounded transition">Salir</button>
          </div>
        </div>
      </div>
      <div class="md:hidden flex justify-around bg-gray-800 p-2 text-xs overflow-x-auto whitespace-nowrap">
        <button onclick="cambiarPesta√±a('plantilla')">üëï Plantilla</button>
        <button onclick="cambiarPesta√±a('mercado')">üí∞ Mercado</button>
        <button onclick="cambiarPesta√±a('clasificacion')">üèÜ Tabla</button>
        <button onclick="cambiarPesta√±a('calendario')">üìÖ Liga</button>
        <button onclick="cambiarPesta√±a('estadisticas')">üìä Stats</button>
      </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-6">
      
      <div id="seccion-estadisticas" class="bloque-contenido hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">üìä Estad√≠sticas de Jugadores</h2>
        <div class="bg-white rounded-lg shadow overflow-hidden overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-800 text-white uppercase">
                    <tr>
                        <th class="p-3">Jugador</th>
                        <th class="p-3 text-center">Pos</th>
                        <th class="p-3 text-center" title="Goles">‚öΩ</th>
                        <th class="p-3 text-center" title="Asistencias">üëü</th>
                        <th class="p-3 text-center hidden sm:table-cell" title="Paradas">üß§</th>
                        <th class="p-3 text-center hidden sm:table-cell" title="Amarillas">üü®</th>
                        <th class="p-3 text-center hidden sm:table-cell" title="Rojas">üü•</th>
                        <th class="p-3 text-right font-bold text-blue-300 bg-gray-900">Puntos Totales</th>
                    </tr>
                </thead>
                <tbody id="tabla-estadisticas" class="divide-y divide-gray-200">
                    <tr><td colspan="8" class="p-4 text-center">Calculando estad√≠sticas...</td></tr>
                </tbody>
            </table>
        </div>
      </div>

      <div id="seccion-calendario" class="bloque-contenido hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">üìÖ Calendario Oficial</h2>
            <button id="btn-crear-partido" onclick="document.getElementById('admin-calendario').classList.toggle('hidden')" class="hidden bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">‚ûï A√±adir Partido</button>
        </div>
        <div id="admin-calendario" class="hidden bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
            <h3 class="font-bold text-blue-800 mb-2 text-sm uppercase">Programar Encuentro</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                <input type="number" id="cal-jornada" placeholder="Jornada (N¬∫)" class="border p-2 rounded">
                <input type="datetime-local" id="cal-fecha" class="border p-2 rounded text-sm">
                <input type="text" id="cal-local" placeholder="Equipo Local" class="border p-2 rounded">
                <input type="text" id="cal-visitante" placeholder="Equipo Visitante" class="border p-2 rounded">
                <button onclick="crearPartido()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded">Guardar</button>
            </div>
        </div>
        <div id="lista-partidos" class="space-y-8"><p class="text-center text-gray-500">Cargando calendario...</p></div>
      </div>

      <div id="seccion-clasificacion" class="bloque-contenido">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">üèÜ Tabla de Puntos</h2>
        <p class="text-sm text-gray-500 mb-4 bg-blue-50 p-2 rounded border border-blue-200">üëÜ <b>Haz clic en un equipo</b> para ver su plantilla y robar jugadores.</p>
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="w-full text-left">
            <thead class="bg-gray-200 text-gray-700 uppercase text-sm">
              <tr>
                <th class="p-4">Pos</th>
                <th class="p-4">Equipo</th>
                <th class="p-4 text-right">Presupuesto</th>
                <th class="p-4 text-right">Puntos</th>
              </tr>
            </thead>
            <tbody id="tabla-ranking">
              <tr><td colspan="4" class="p-4 text-center animate-pulse">Cargando clasificaci√≥n...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="seccion-plantilla" class="bloque-contenido hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">üìã Pizarra T√°ctica</h2>
            <div class="text-right">
                <p class="text-xs text-gray-500">Valor Equipo</p>
                <p id="valor-plantilla" class="font-bold text-green-600 text-lg">0 M‚Ç¨</p>
            </div>
        </div>

        <div id="buzon-ofertas" class="mb-6 hidden">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded shadow-sm">
                <div class="flex items-center mb-3">
                    <span class="text-2xl mr-2">üì¨</span>
                    <h3 class="text-lg font-bold text-yellow-800">Ofertas Recibidas</h3>
                </div>
                <div id="lista-ofertas" class="space-y-3"></div>
            </div>
        </div>

        <div class="mb-8 relative">
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-2">3 Inicial (1-1-1-1)</h3>
            <div class="bg-cesped rounded-xl border-4 border-green-800 p-6 shadow-2xl flex flex-col items-center gap-6 relative overflow-hidden min-h-[400px]">
                <div class="absolute top-1/2 left-0 w-full h-0.5 bg-white opacity-30"></div>
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-32 border-2 border-white opacity-30 rounded-full"></div>
                <div id="campo-titulares" class="w-full max-w-md flex flex-col gap-4 z-10">
                    <p class="text-white text-center opacity-70">Cargando t√°ctica...</p>
                </div>
            </div>
        </div>
        
        <div>
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-2">Banquillo</h3>
            <div id="grid-suplentes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 opacity-80"></div>
        </div>
      </div>

      <div id="seccion-mercado" class="bloque-contenido hidden">
        <div id="mercado-estado-banner" class="bg-gray-100 p-3 rounded mb-4 text-center border border-gray-300">
            <h3 id="mercado-status-text" class="font-bold text-lg">Cargando estado...</h3>
            <p id="mercado-timer" class="text-sm font-mono">--:--:--</p>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center mb-6 sticky top-16 bg-gray-100 z-40 py-4 gap-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">üí∞ Mercado de Fichajes</h2>
                <p class="text-xs text-gray-500">Puja m√≠nima: 50%. Cl√°usula: 150%.</p>
            </div>
            <div class="flex gap-2 items-center flex-wrap justify-end">
                <button id="btn-admin-precios" onclick="actualizarPreciosSemana()" class="hidden bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-2 rounded shadow border border-blue-800 flex items-center gap-1">üîÑ Precios</button>
                <button id="btn-admin-fichajes" onclick="resolverMercado()" class="hidden bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-2 rounded shadow border border-purple-800 flex items-center gap-1">‚ö° Fichajes</button>
                <div class="text-right bg-white px-4 py-2 rounded-lg shadow border border-green-200 ml-2">
                    <p class="text-xs text-gray-500 uppercase font-bold">Tu Saldo</p>
                    <p id="mercado-presupuesto" class="font-mono font-bold text-green-600 text-xl">...</p>
                </div>
            </div>
        </div>

        <div id="mercado-contenido">
            <div class="mb-8">
                <h3 class="font-bold text-green-800 text-lg mb-4 flex items-center gap-2 border-b border-green-200 pb-2">
                    <span class="bg-green-100 p-1 rounded">üü¢</span> Agentes Libres (Pujas)
                </h3>
                <div id="grid-mercado-libres" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-center text-gray-500 col-span-3 animate-pulse">Analizando...</p>
                </div>
            </div>
            <div>
                <h3 class="font-bold text-red-800 text-lg mb-4 flex items-center gap-2 border-b border-red-200 pb-2">
                    <span class="bg-red-100 p-1 rounded">üî¥</span> Jugadores con Contrato (Cl√°usulazos)
                </h3>
                <div id="grid-mercado-ocupados" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 opacity-90">
                    <p class="text-center text-gray-500 col-span-3">Cargando...</p>
                </div>
            </div>
        </div>
      </div>
    </main>

    <div id="modal-partido" class="fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden relative">
            <div class="bg-gray-900 p-6 text-center relative text-white">
                <button onclick="cerrarModal('modal-partido')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">‚úï</button>
                <p id="popup-jornada" class="text-xs uppercase tracking-widest text-gray-400 mb-2">Jornada X</p>
                <p id="popup-fecha" class="text-sm font-bold text-yellow-400 mb-4">--:--</p>
                <div class="flex justify-between items-center px-4">
                    <div class="text-center w-1/3"><div class="w-12 h-12 bg-white rounded-full mx-auto flex items-center justify-center text-gray-900 font-black text-xl mb-2 shadow-lg border-2 border-gray-300">‚ö™</div><p id="popup-local" class="font-bold text-lg leading-tight">Local</p></div>
                    <div class="text-center w-1/3"><p id="popup-marcador" class="text-4xl font-black font-mono">VS</p></div>
                    <div class="text-center w-1/3"><div class="w-12 h-12 bg-black rounded-full mx-auto flex items-center justify-center text-white font-black text-xl mb-2 shadow-lg border-2 border-gray-600">‚ö´</div><p id="popup-visitante" class="font-bold text-lg leading-tight">Visitante</p></div>
                </div>
            </div>
            <div id="admin-partido-controls" class="hidden p-6 bg-gray-50 border-t">
                <p class="text-xs font-bold text-gray-500 uppercase mb-2 text-center">Editar Marcador (Admin)</p>
                <div class="flex justify-center gap-4 mb-4">
                    <input type="number" id="edit-goles-local" class="w-16 p-2 text-center border rounded text-xl font-bold" placeholder="0">
                    <span class="text-xl font-bold pt-2">-</span>
                    <input type="number" id="edit-goles-visitante" class="w-16 p-2 text-center border rounded text-xl font-bold" placeholder="0">
                </div>
                <button onclick="guardarResultadoPartido()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow">Actualizar Resultado</button>
            </div>
        </div>
    </div>

    <div id="modal-jugador" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden transform transition-all scale-100">
            <div class="bg-gray-900 p-6 text-center relative">
                <button onclick="cerrarModal('modal-jugador')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">‚úï</button>
                <div class="w-24 h-24 mx-auto rounded-full border-4 border-white overflow-hidden shadow-lg mb-3">
                    <img id="modal-foto" src="" class="w-full h-full object-cover">
                </div>
                <h3 id="modal-nombre" class="text-xl font-bold text-white">Nombre Jugador</h3>
                <p id="modal-posicion" class="text-sm text-blue-300 font-bold tracking-wider uppercase">Posici√≥n</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-4 gap-2 mb-4 text-center text-xs font-bold bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="text-green-600" title="Goles">‚öΩ <span id="modal-stat-goles">0</span></div>
                    <div class="text-blue-600" title="Asistencias">üëü <span id="modal-stat-asist">0</span></div>
                    <div class="text-orange-600" title="Robos">‚öîÔ∏è <span id="modal-stat-robos">0</span></div>
                    <div class="col-span-1 text-purple-700 font-black text-sm bg-purple-50 rounded" title="Puntos Totales">üéØ <span id="modal-stat-puntos">0</span></div>
                </div>

                <div class="flex justify-between items-center mb-6 bg-white p-3 rounded border shadow-sm">
                    <span class="text-gray-500 text-sm">Valor</span>
                    <span id="modal-precio" class="font-mono font-bold text-green-600 text-lg">0 M‚Ç¨</span>
                </div>
                <div class="flex justify-between items-center mb-6">
                     <span class="text-gray-500 text-sm">Estado actual:</span>
                     <span id="modal-estado" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-200">...</span>
                </div>
                <div class="space-y-3 pt-2 border-t">
                    <button id="btn-titular" onclick="" class="w-full py-3 rounded-lg font-bold text-white transition shadow-md">Cambiar Estado</button>
                    <button id="btn-vender" onclick="" class="w-full py-3 rounded-lg font-bold text-red-600 border border-red-200 hover:bg-red-50 transition">üí∞ Vender Jugador</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-equipo" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all scale-100 flex flex-col max-h-[80vh]">
            <div class="bg-blue-900 p-4 flex justify-between items-center text-white shrink-0">
                <h3 id="modal-equipo-nombre" class="text-xl font-bold">Nombre Equipo</h3>
                <button onclick="cerrarModal('modal-equipo')" class="text-gray-300 hover:text-white text-2xl">‚úï</button>
            </div>
            <div id="modal-equipo-lista" class="p-4 overflow-y-auto bg-gray-50">
                <p class="text-center text-gray-500">Cargando plantilla...</p>
            </div>
            <div class="bg-white p-3 text-center text-xs text-gray-400 border-t shrink-0">
                Pulsa el üí∏ para ofertar o robar.
            </div>
        </div>
    </div>

    <div id="modal-compra-rival" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-2">üí∏ Oferta por Jugador</h3>
            <p id="rival-nombre-jugador" class="text-blue-600 font-bold text-lg mb-4">...</p>
            <div class="bg-gray-100 p-4 rounded-lg mb-4 text-left space-y-2">
                <div class="flex justify-between"><span class="text-gray-500">Valor Mercado:</span><span id="rival-precio-valor" class="font-bold">...</span></div>
                <div class="flex justify-between text-red-600"><span class="font-bold">‚ö° Cl√°usula (150%):</span><span id="rival-precio-clausula" class="font-bold">...</span></div>
            </div>
            <p class="text-xs text-gray-500 mb-2">Oferta la cl√°usula para ficharlo YA o negocia.</p>
            <input type="number" id="input-oferta-rival" placeholder="Cantidad en ‚Ç¨" class="w-full border p-2 rounded mb-4 text-center font-bold text-lg">
            <div class="flex gap-2">
                <button onclick="cerrarModal('modal-compra-rival')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-lg font-bold">Cancelar</button>
                <button id="btn-confirmar-compra-rival" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-bold">Enviar Oferta</button>
            </div>
        </div>
    </div>

    <div id="modal-puntos" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üìù Acta del Partido</h3>
                <button onclick="document.getElementById('modal-puntos').classList.add('hidden')" class="text-gray-400 hover:text-black">‚úï</button>
            </div>
            
            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Jugador</label>
            <select id="select-jugador-puntos" onchange="calcularPuntosEnVivo()" class="w-full border p-2 rounded mb-4 bg-gray-50">
                <option value="">Cargando jugadores...</option>
            </select>

            <div class="grid grid-cols-3 gap-2 mb-4">
                <div><label class="block text-[10px] font-bold text-green-700">‚öΩ Gol</label><input type="number" id="stats-goles" value="0" min="0" onchange="calcularPuntosEnVivo()" class="w-full border p-1 text-center"></div>
                <div><label class="block text-[10px] font-bold text-blue-700">üëü Asist</label><input type="number" id="stats-asist" value="0" min="0" onchange="calcularPuntosEnVivo()" class="w-full border p-1 text-center"></div>
                <div><label class="block text-[10px] font-bold text-purple-700">üß§ Parada</label><input type="number" id="stats-paradas" value="0" min="0" onchange="calcularPuntosEnVivo()" class="w-full border p-1 text-center"></div>
                
                <div><label class="block text-[10px] font-bold text-orange-600">‚öîÔ∏è Robos</label><input type="number" id="stats-recuperaciones" value="0" min="0" onchange="calcularPuntosEnVivo()" class="w-full border p-1 text-center font-bold text-orange-800 bg-orange-50"></div>
                
                <div><label class="block text-[10px] font-bold text-red-600">üü• Roja</label><input type="number" id="stats-roja" value="0" min="0" onchange="calcularPuntosEnVivo()" class="w-full border p-1 text-center"></div>
                <div><label class="block text-[10px] font-bold text-yellow-600">üü® Amar</label><input type="number" id="stats-ama" value="0" min="0" onchange="calcularPuntosEnVivo()" class="w-full border p-1 text-center"></div>
                
                <div class="col-span-3 mt-2 border-t pt-2"><label class="block text-[10px] font-bold text-gray-500 text-center">ü•Ö Goles Encajados (Resta -0.5)</label><input type="number" id="stats-encajados" value="0" min="0" onchange="calcularPuntosEnVivo()" class="w-full border p-1 text-center bg-gray-100"></div>
            </div>

            <div class="bg-gray-100 p-3 rounded mb-4">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Base: +2</span>
                    <span id="info-bonus-posicion">...</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xl font-bold text-gray-800">Total:</span>
                    <span id="puntos-preview" class="text-2xl font-black text-blue-600">2</span>
                </div>
            </div>

            <button onclick="guardarPuntos()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transform active:scale-95 transition">
                üíæ Guardar Estad√≠sticas
            </button>
        </div>
    </div>

    <script>
      // --- 1. CONFIGURACI√ìN E INICIALIZACI√ìN ---
      const supabaseUrl = "https://jruomktwaehlocyrivsx.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpydW9ta3R3YWVobG9jeXJpdnN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MTc0NTAsImV4cCI6MjA4MTE5MzQ1MH0.CDhHO5jFLNrIaf-yffEcGViaDN01L4sqwRFpFtnIBCg"; 
      const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
      
      const EMAIL_ADMIN = "m.liang.perarnau@gmail.com"; 

      let partidoActualId = null;
      let jugadorActualId = null;
      let esTitularActual = false;
      let mercadoAbierto = true;

      // --- 2. FUNCIONES DE UTILIDAD (UTILS) ---
      function generarBadgePrecio(actual, anterior) {
          if (!anterior || anterior === 0) return '<span class="text-[10px] text-gray-400 ml-1">=</span>';
          const diff = actual - anterior;
          if (diff === 0) return '<span class="text-[10px] text-gray-400 ml-1">=</span>';
          const porc = ((Math.abs(diff) / anterior) * 100).toFixed(1);
          if (diff > 0) return `<span class="text-[10px] font-bold text-green-600 bg-green-100 px-1 rounded ml-1">‚¨ÜÔ∏è ${porc}%</span>`;
          return `<span class="text-[10px] font-bold text-red-600 bg-red-100 px-1 rounded ml-1">‚¨áÔ∏è ${porc}%</span>`;
      }

      function getColorBorde(pos) {
        if (pos === "PORTERO") return "border-yellow-400";
        if (pos === "DEFENSA") return "border-blue-400";
        if (pos === "MEDIO") return "border-green-400";
        if (pos === "DELANTERO") return "border-red-400";
        return "border-gray-300";
      }

      function ordenPos(p) { return {'PORTERO':1,'DEFENSA':2,'MEDIO':3,'DELANTERO':4}[p] || 99; }
      function cerrarModal(id) { document.getElementById(id).classList.add('hidden'); }
      
      function formatTiempo(ms) {
          const d = Math.floor(ms / (1000 * 60 * 60 * 24));
          const h = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
          return `${d}d ${h}h ${m}m`;
      }

      // --- 3. NAVEGACI√ìN ---
      function cambiarPesta√±a(n) {
        ['clasificacion','plantilla','mercado','calendario','estadisticas'].forEach(t => {
            const sec = document.getElementById('seccion-'+t); if(sec) sec.classList.add('hidden');
            const btn = document.getElementById('tab-'+t); if(btn) btn.classList.remove('btn-activo');
        });
        const activeSec = document.getElementById("seccion-" + n); if(activeSec) activeSec.classList.remove("hidden");
        const activeBtn = document.getElementById("tab-" + n); if(activeBtn) activeBtn.classList.add("btn-activo");
        
        if(n==='plantilla') cargarPlantilla();
        if(n==='mercado') cargarMercado();
        if(n==='calendario') cargarCalendario();
        if(n==='estadisticas') cargarEstadisticas();
        if(n==='clasificacion') cargarRanking();
      }

      // --- 4. AUTH Y RANKING ---
      async function checkSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) window.location.href = "index.html";
        else {
          document.getElementById("user-email").innerText = session.user.email;
          if(session.user.email === EMAIL_ADMIN) {
            ['btn-admin-puntos','btn-admin-precios','btn-admin-fichajes','btn-crear-partido','admin-partido-controls', 'btn-admin-recalc'].forEach(id => {
                const el = document.getElementById(id); if(el) el.classList.remove('hidden');
            });
          }
          cargarRanking();
        }
      }
      checkSession();

      async function cargarRanking() {
        const { data: equipos, error } = await _supabase.from("equipos_fantasy").select("*").order("puntos_totales", { ascending: false });
        if (error) return console.error(error);
        const tabla = document.getElementById("tabla-ranking");
        tabla.innerHTML = "";
        
        equipos.forEach((eq, index) => {
          const clickEvento = `verEquipo(${eq.id}, '${eq.nombre_equipo.replace(/'/g, "\\'")}')`;
          tabla.innerHTML += `
            <tr onclick="${clickEvento}" class="border-b hover:bg-blue-50 transition cursor-pointer">
                <td class="p-4 font-bold text-gray-500">#${index + 1}</td>
                <td class="p-4 font-bold text-lg text-gray-800">${eq.nombre_equipo}</td>
                <td class="p-4 text-right text-green-600 font-mono font-bold">${(eq.presupuesto / 1000000).toFixed(0)}M ‚Ç¨</td>
                <td class="p-4 text-right font-bold text-blue-600 text-xl">${eq.puntos_totales.toFixed(1)} pts</td>
            </tr>`;
        });
      }

      // --- 5. ESTAD√çSTICAS ---
      async function cargarEstadisticas() {
          const tabla = document.getElementById('tabla-estadisticas');
          tabla.innerHTML = '<tr><td colspan="8" class="p-4 text-center">Cargando datos...</td></tr>';
          const { data: jugadores } = await _supabase.from('jugadores').select('*');
          const { data: actuaciones } = await _supabase.from('actuaciones').select('*');

          if (!jugadores) return;

          const stats = jugadores.map(j => {
              const susActuaciones = actuaciones ? actuaciones.filter(a => a.jugador_id === j.id) : [];
              const totalGoles = susActuaciones.reduce((sum, a) => sum + (a.goles || 0), 0);
              const totalAsist = susActuaciones.reduce((sum, a) => sum + (a.asistencias || 0), 0);
              const totalParadas = susActuaciones.reduce((sum, a) => sum + (a.paradas || 0), 0);
              const totalAma = susActuaciones.reduce((sum, a) => sum + (a.amarillas || 0), 0);
              const totalRojas = susActuaciones.reduce((sum, a) => sum + (a.rojas || 0), 0);
              const totalPuntos = susActuaciones.reduce((sum, a) => sum + (a.puntos_calculados || 0), 0);

              return { ...j, totalGoles, totalAsist, totalParadas, totalAma, totalRojas, totalPuntos };
          });

          stats.sort((a, b) => b.totalPuntos - a.totalPuntos);

          tabla.innerHTML = '';
          if (stats.length === 0) {
              tabla.innerHTML = '<tr><td colspan="8" class="p-4 text-center">No hay datos a√∫n.</td></tr>';
              return;
          }

          stats.forEach(s => {
              tabla.innerHTML += `
                  <tr class="border-b hover:bg-gray-50">
                      <td class="p-3 flex items-center gap-2 font-bold text-gray-700">
                          <img src="${s.foto_url}" class="w-8 h-8 rounded-full bg-gray-200 object-cover">
                          ${s.nombre}
                      </td>
                      <td class="p-3 text-center text-xs font-bold text-gray-500">${s.posicion.substring(0,3)}</td>
                      <td class="p-3 text-center font-bold text-green-600">${s.totalGoles > 0 ? s.totalGoles : '-'}</td>
                      <td class="p-3 text-center font-bold text-blue-600">${s.totalAsist > 0 ? s.totalAsist : '-'}</td>
                      <td class="p-3 text-center text-gray-600 hidden sm:table-cell">${s.totalParadas > 0 ? s.totalParadas : '-'}</td>
                      <td class="p-3 text-center text-yellow-600 hidden sm:table-cell">${s.totalAma > 0 ? s.totalAma : '-'}</td>
                      <td class="p-3 text-center text-red-600 hidden sm:table-cell">${s.totalRojas > 0 ? s.totalRojas : '-'}</td>
                      <td class="p-3 text-right font-black text-xl text-blue-800 bg-blue-50">${s.totalPuntos.toFixed(1)}</td>
                  </tr>
              `;
          });
      }

      // --- 6. MERCADO Y TEMPORIZADOR ---
      function actualizarEstadoMercado() {
          const now = new Date();
          const day = now.getDay(); 
          const banner = document.getElementById('mercado-estado-banner');
          const statusText = document.getElementById('mercado-status-text');
          const timerText = document.getElementById('mercado-timer');
          const grid = document.getElementById('grid-mercado-libres'); 
          const grid2 = document.getElementById('grid-mercado-ocupados'); 

          let isOpen = false;
          let targetDate = new Date();
          targetDate.setHours(0, 0, 0, 0);

          if (day >= 1 && day <= 4) {
              isOpen = true;
              const daysUntilFriday = 5 - day;
              targetDate.setDate(now.getDate() + daysUntilFriday);
          } else {
              isOpen = false;
              let daysUntilMonday = 1;
              if (day === 5) daysUntilMonday = 3; 
              if (day === 6) daysUntilMonday = 2; 
              if (day === 0) daysUntilMonday = 1; 
              targetDate.setDate(now.getDate() + daysUntilMonday);
          }

          const diff = targetDate - now;
          const timeLeft = formatTiempo(diff);
          mercadoAbierto = isOpen;

          if (isOpen) {
              banner.className = "bg-green-100 p-3 rounded mb-4 text-center border border-green-300 shadow-sm";
              statusText.innerHTML = "üü¢ <span class='text-green-800'>MERCADO ABIERTO</span>";
              timerText.innerText = "Cierra en: " + timeLeft;
              if(grid) grid.classList.remove('mercado-cerrado');
              if(grid2) grid2.classList.remove('mercado-cerrado');
          } else {
              banner.className = "bg-red-100 p-3 rounded mb-4 text-center border border-red-300 shadow-sm";
              statusText.innerHTML = "üî¥ <span class='text-red-800'>MERCADO CERRADO</span>";
              timerText.innerText = "Abre en: " + timeLeft;
              if(grid) grid.classList.add('mercado-cerrado');
              if(grid2) grid2.classList.add('mercado-cerrado');
          }
      }

      setInterval(actualizarEstadoMercado, 1000);

      async function cargarMercado() {
        actualizarEstadoMercado(); 
        
        const gridLibres = document.getElementById('grid-mercado-libres'); 
        const gridOcupados = document.getElementById('grid-mercado-ocupados'); 
        
        gridLibres.innerHTML = '<p class="text-center col-span-3 animate-pulse">Cargando...</p>';
        gridOcupados.innerHTML = '<p class="text-center col-span-3 animate-pulse">Cargando...</p>';

        const { data: { user } } = await _supabase.auth.getUser();
        const { data: eq } = await _supabase.from('equipos_fantasy').select('id, presupuesto').eq('usuario_id', user.id).single();
        if(!eq) { gridLibres.innerHTML = '<p class="text-center text-red-500 col-span-3">Crea equipo primero.</p>'; gridOcupados.innerHTML = ''; return; }
        document.getElementById('mercado-presupuesto').innerText = (eq.presupuesto/1000000).toFixed(1) + ' M‚Ç¨';

        // 1. Due√±os
        const { data: plantilla } = await _supabase.from('plantilla').select('jugador_id, equipos_fantasy(nombre_equipo, id)');
        const owners = {};
        const ocupadosIds = [];
        
        if (plantilla) {
            plantilla.forEach(p => {
                owners[p.jugador_id] = {
                    nombre: p.equipos_fantasy ? p.equipos_fantasy.nombre_equipo : 'Desconocido',
                    id: p.equipos_fantasy ? p.equipos_fantasy.id : null
                };
                ocupadosIds.push(p.jugador_id);
            });
        }

        // 2. Pujas
        const { data: p } = await _supabase.from('pujas').select('jugador_id, monto, equipo_id, equipos_fantasy(nombre_equipo)');
        const pujas = {}; 
        if(p) {
            p.forEach(x => { 
                if(!pujas[x.jugador_id]) pujas[x.jugador_id]={max:0,mi:0,lider:''}; 
                if(x.monto > pujas[x.jugador_id].max) {
                    pujas[x.jugador_id].max = x.monto;
                    pujas[x.jugador_id].lider = x.equipos_fantasy ? x.equipos_fantasy.nombre_equipo : 'Desc.';
                }
                if(x.equipo_id === eq.id) pujas[x.jugador_id].mi = x.monto; 
            });
        }

        // 3. Puntos y Render
        const { data: acts } = await _supabase.from('actuaciones').select('jugador_id, puntos_calculados');
        const pts = {}; if(acts) acts.forEach(a => { if(!pts[a.jugador_id]) pts[a.jugador_id]=0; pts[a.jugador_id]+=a.puntos_calculados; });
        
        const { data: all, error } = await _supabase.from('jugadores').select('*').order('precio', { ascending: false });
        if(error || !all || !all.length) { gridLibres.innerHTML = '<p class="text-center col-span-3 text-red-500">Base de datos vac√≠a.</p>'; return; }
        
        gridLibres.innerHTML = '';
        gridOcupados.innerHTML = '';

        let hayLibres = false;
        let hayOcupados = false;

        all.forEach(j => {
            const inf = pujas[j.id] || {max:0,mi:0,lider:''};
            const textoLider = inf.max > 0 ? `<span class="text-[10px] text-gray-500 font-normal ml-1">(${inf.lider})</span>` : '';
            const puntos = pts[j.id] ? pts[j.id].toFixed(1) : 0;

            const cartaHTML = (tipo, ownerName = null, ownerId = null) => `
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 ${getColorBorde(j.posicion)} ${inf.mi>0?'ring-2 ring-purple-500':''} flex flex-col gap-3 relative">
                ${ownerName ? `<div class="absolute top-2 right-2 bg-gray-100 text-gray-600 text-[10px] px-2 py-1 rounded font-bold border">üë§ ${ownerName}</div>` : ''}
                <div onclick="abrirModalJugador(${j.id}, '${j.nombre.replace(/'/g,"\\'")}', '${j.posicion}', ${j.precio}, '${j.foto_url}', false)" class="flex gap-3 cursor-pointer">
                    <div class="w-14 h-14 rounded-full bg-gray-200 overflow-hidden"><img src="${j.foto_url}" class="w-full h-full object-cover"></div>
                    <div class="w-full">
                        <div class="flex justify-between mt-1">
                            <div>
                                <p class="text-[10px] font-bold text-gray-400">${j.posicion}</p>
                                <div class="flex items-center"><h3 class="font-bold text-sm hover:text-blue-600">${j.nombre}</h3>${generarBadgePrecio(j.precio, j.precio_anterior)}</div>
                            </div>
                            <div class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold h-fit">üéØ ${puntos}</div>
                        </div>
                        ${tipo === 'libre' ? 
                        `<div class="grid grid-cols-2 gap-2 mt-2 text-xs bg-gray-50 p-2 rounded"><div><p class="text-gray-400">Valor</p><p class="font-bold">${(j.precio/1000000).toFixed(1)} M‚Ç¨</p></div><div><p class="text-orange-500 font-bold">üî• Max ${textoLider}</p><p class="font-bold">${inf.max>0?(inf.max/1000000).toFixed(1)+'M':'-'}</p></div></div>` :
                        `<div class="mt-2 text-xs bg-gray-50 p-2 rounded"><div class="flex justify-between"><span class="text-gray-400">Valor:</span><span class="font-bold">${(j.precio/1000000).toFixed(1)} M‚Ç¨</span></div><div class="flex justify-between text-red-600 font-bold"><span>Cl√°usula:</span><span>${(j.precio*1.5/1000000).toFixed(1)} M‚Ç¨</span></div></div>`
                        }
                    </div>
                </div>
                <div class="flex gap-2 border-t pt-2">
                    ${tipo === 'libre' ? 
                    `<input type="number" id="inp-${j.id}" class="w-full text-sm border rounded px-1" value="${j.precio}" placeholder="Min: ${(j.precio/2000000).toFixed(1)}M"><button onclick="realizarPuja(${j.id}, '${j.nombre.replace(/'/g,"\\'")}', ${j.precio})" class="bg-purple-600 text-white text-xs font-bold px-3 rounded hover:bg-purple-700 transition">Pujar</button>` :
                    `<button onclick="abrirModalCompraRival(${j.id}, '${j.nombre.replace(/'/g,"\\'")}', ${j.precio}, ${ownerId})" class="w-full bg-green-600 text-white text-xs font-bold px-3 py-2 rounded hover:bg-green-700 transition flex items-center justify-center gap-1">üí∏ Ofertar / Robar</button>`
                    }
                </div>
            </div>`;

            if (ocupadosIds.includes(j.id)) {
                const owner = owners[j.id];
                if (owner.id !== eq.id) {
                    gridOcupados.innerHTML += cartaHTML('ocupado', owner.nombre, owner.id);
                    hayOcupados = true;
                }
            } else {
                gridLibres.innerHTML += cartaHTML('libre');
                hayLibres = true;
            }
        });

        if (!hayLibres) gridLibres.innerHTML = '<p class="text-center col-span-3 text-gray-400 italic">No hay jugadores libres.</p>';
        if (!hayOcupados) gridOcupados.innerHTML = '<p class="text-center col-span-3 text-gray-400 italic">No hay jugadores de rivales disponibles.</p>';
      }

      async function realizarPuja(id, n, v) {
          if (!mercadoAbierto) return alert("‚õî El mercado est√° CERRADO. Vuelve el lunes.");
          const m = parseInt(document.getElementById(`inp-${id}`).value);
          const minBid = v / 2;
          if (m < minBid) return alert(`‚õî La puja m√≠nima es: ${(minBid/1000000).toFixed(2)} M‚Ç¨`);

          const { data: { user } } = await _supabase.auth.getUser();
          const { data: eq } = await _supabase.from('equipos_fantasy').select('id, presupuesto').eq('usuario_id', user.id).single();
          if(eq.presupuesto < m) return alert("‚õî No tienes suficiente dinero.");
          
          await _supabase.from('pujas').delete().eq('equipo_id', eq.id).eq('jugador_id', id);
          await _supabase.from('pujas').insert({ equipo_id: eq.id, jugador_id: id, monto: m });
          alert("‚úÖ Puja realizada."); cargarMercado();
      }

      async function resolverMercado() {
        if (!confirm("‚ö†Ô∏è ADMIN: ¬øCerrar mercado?")) return;
        const { data: pujas } = await _supabase.from('pujas').select('*').order('monto', { ascending: false });
        const ganadores = {}; pujas.forEach(p => { if (!ganadores[p.jugador_id]) ganadores[p.jugador_id] = p; });
        let c = 0;
        for (const p of Object.values(ganadores)) {
            const { data: eq } = await _supabase.from('equipos_fantasy').select('presupuesto').eq('id', p.equipo_id).single();
            await _supabase.from('equipos_fantasy').update({ presupuesto: eq.presupuesto - p.monto }).eq('id', p.equipo_id);
            await _supabase.from('plantilla').insert({ equipo_id: p.equipo_id, jugador_id: p.jugador_id, es_titular: false });
            await _supabase.from('pujas').delete().eq('jugador_id', p.jugador_id);
            c++;
        }
        alert(`Resuelto: ${c} fichajes.`); cargarMercado();
      }

      async function actualizarPreciosSemana() {
          if (!confirm("‚ö†Ô∏è ADMIN: ¬øSimular precios?")) return;
          const { data: jugadores } = await _supabase.from('jugadores').select('*');
          for (const j of jugadores) {
              const factor = 0.95 + Math.random() * 0.15;
              const nuevoPrecio = Math.round(j.precio * factor);
              await _supabase.from('jugadores').update({ precio: nuevoPrecio, precio_anterior: j.precio }).eq('id', j.id);
          }
          alert("Precios actualizados."); cargarMercado(); cargarPlantilla();
      }

      // --- 7. CALENDARIO ---
      async function cargarCalendario() {
          const lista = document.getElementById('lista-partidos');
          lista.innerHTML = '<p class="text-center text-gray-500">Cargando...</p>';
          const { data: partidos } = await _supabase.from('partidos').select('*').order('jornada').order('fecha');
          if(!partidos || partidos.length === 0) { lista.innerHTML = '<p class="text-center text-gray-400">No hay partidos.</p>'; return; }
          const porJornada = {}; partidos.forEach(p => { if(!porJornada[p.jornada]) porJornada[p.jornada] = []; porJornada[p.jornada].push(p); });
          lista.innerHTML = '';
          Object.keys(porJornada).forEach(j => {
              let html = `<div class="mb-8"><h3 class="font-bold text-lg text-gray-800 border-b-2 border-gray-200 mb-4 pb-1">Jornada ${j}</h3><div class="grid gap-4 md:grid-cols-2">`;
              porJornada[j].forEach(p => {
                  const d = new Date(p.fecha);
                  const dia = d.toLocaleDateString('es-ES', { weekday:'short', day:'numeric' });
                  const hora = d.toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit' });
                  const est = p.jugado ? `<span class="text-xl font-bold text-gray-800">${p.goles_local} - ${p.goles_visitante}</span>` : `<span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded">${dia} ${hora}</span>`;
                  html += `<div onclick="abrirPopUpPartido(${p.id}, '${p.equipo_local}', '${p.equipo_visitante}', ${p.goles_local}, ${p.goles_visitante}, ${p.jugado}, '${dia} ${hora}', ${p.jornada})" class="bg-white p-4 rounded-xl shadow hover:shadow-lg transition cursor-pointer border border-gray-100 flex items-center justify-between"><div class="flex items-center gap-3 w-5/12"><div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center font-bold text-gray-500 border">‚ö™</div><span class="font-bold text-gray-700 truncate">${p.equipo_local}</span></div><div class="w-2/12 text-center">${est}</div><div class="flex items-center gap-3 w-5/12 justify-end"><span class="font-bold text-gray-700 truncate">${p.equipo_visitante}</span><div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center font-bold text-white border">‚ö´</div></div></div>`;
              });
              html += `</div></div>`; lista.innerHTML += html;
          });
      }

      async function crearPartido() {
          const j = document.getElementById('cal-jornada').value; const f = document.getElementById('cal-fecha').value; const l = document.getElementById('cal-local').value; const v = document.getElementById('cal-visitante').value;
          if(!j || !f || !l || !v) return alert("Datos incorrectos");
          const { error } = await _supabase.from('partidos').insert({ jornada: j, fecha: f, equipo_local: l, equipo_visitante: v });
          if(error) alert(error.message); else { alert("Partido creado"); cargarCalendario(); }
      }

      function abrirPopUpPartido(id, l, v, gl, gv, jug, f, j) {
          partidoActualId = id;
          document.getElementById('popup-jornada').innerText = `Jornada ${j}`; document.getElementById('popup-fecha').innerText = f;
          document.getElementById('popup-local').innerText = l; document.getElementById('popup-visitante').innerText = v;
          const m = document.getElementById('popup-marcador');
          if(jug) { m.innerText = `${gl} - ${gv}`; m.className = "text-5xl font-black text-white"; } else { m.innerText = "VS"; m.className = "text-4xl font-mono text-gray-400"; }
          document.getElementById('edit-goles-local').value = gl; document.getElementById('edit-goles-visitante').value = gv;
          const em = document.getElementById('user-email').innerText;
          if(em === EMAIL_ADMIN) document.getElementById('admin-partido-controls').classList.remove('hidden'); else document.getElementById('admin-partido-controls').classList.add('hidden');
          document.getElementById('modal-partido').classList.remove('hidden');
      }

      async function guardarResultadoPartido() {
          await _supabase.from('partidos').update({ goles_local: document.getElementById('edit-goles-local').value, goles_visitante: document.getElementById('edit-goles-visitante').value, jugado: true }).eq('id', partidoActualId);
          cerrarModal('modal-partido'); cargarCalendario();
      }

      // --- 8. √ÅRBITRO, RANKING, PLANTILLA ---
      async function abrirGestorPuntos() { document.getElementById('modal-puntos').classList.remove('hidden'); const s = document.getElementById('select-jugador-puntos'); const { data: j } = await _supabase.from('jugadores').select('id, nombre, posicion').order('nombre'); s.innerHTML = '<option value="" data-pos="">-- Elige --</option>'; j.forEach(x => s.innerHTML += `<option value="${x.id}" data-pos="${x.posicion}">${x.nombre} (${x.posicion})</option>`); ['goles','asist','paradas','ama','roja','encajados','recuperaciones'].forEach(k => document.getElementById('stats-'+k).value=0); calcularPuntosEnVivo(); }
      
      // --- F√ìRMULA DE PUNTUACI√ìN ---
      function calcularFormula(stats, pos) {
          let vg = 4, ve = 0, v_recup = 0.5; let vp = 0.89;
          if (pos === 'MEDIO') { vg = 5; v_recup = 1; }
          if (pos === 'DEFENSA') { vg = 6; ve = 0.5; v_recup = 2; }
          if (pos === 'PORTERO') { vg = 9; ve = 0.5; vp = 0.5; v_recup = 2; }

          const total = 2 + (stats.goles * vg) + (stats.asistencias * 3) + (stats.paradas * vp) + (stats.recuperaciones * v_recup) - (stats.amarillas * 2) - (stats.rojas * 5) - (stats.goles_encajados * ve);
          return Math.round(total * 100) / 100;
      }

      function calcularPuntosEnVivo() {
          const s = document.getElementById('select-jugador-puntos');
          const pos = s.options[s.selectedIndex].getAttribute('data-pos');
          const stats = {
              goles: parseInt(document.getElementById('stats-goles').value)||0,
              asistencias: parseInt(document.getElementById('stats-asist').value)||0,
              paradas: parseInt(document.getElementById('stats-paradas').value)||0,
              amarillas: parseInt(document.getElementById('stats-ama').value)||0,
              rojas: parseInt(document.getElementById('stats-roja').value)||0,
              goles_encajados: parseInt(document.getElementById('stats-encajados').value)||0,
              recuperaciones: parseInt(document.getElementById('stats-recuperaciones').value)||0
          };
          const t = calcularFormula(stats, pos);
          const prev = document.getElementById('puntos-preview');
          prev.innerText = t;
          prev.className = t >= 0 ? "text-2xl font-black text-blue-600" : "text-2xl font-black text-red-600";
          document.getElementById('info-bonus-posicion').innerText = `Gol: +${pos==='DEFENSA'?6:4}`;
      }

      async function guardarPuntos() { 
          const jId = document.getElementById('select-jugador-puntos').value; 
          if(!jId) return alert("Elige jugador"); 
          const pts = parseFloat(document.getElementById('puntos-preview').innerText); 
          await _supabase.from('actuaciones').insert({ 
              jugador_id: jId, puntos_calculados: pts, 
              goles: document.getElementById('stats-goles').value, 
              asistencias: document.getElementById('stats-asist').value, 
              paradas: document.getElementById('stats-paradas').value, 
              amarillas: document.getElementById('stats-ama').value, 
              rojas: document.getElementById('stats-roja').value,
              goles_encajados: document.getElementById('stats-encajados').value,
              recuperaciones: document.getElementById('stats-recuperaciones').value 
          }); 
          const { data: f } = await _supabase.from('plantilla').select('equipo_id').eq('jugador_id', jId).maybeSingle(); 
          if(f) { 
              const { data: eq } = await _supabase.from('equipos_fantasy').select('id, puntos_totales, nombre_equipo').eq('id', f.equipo_id).single(); 
              const nuevosPuntos = (eq.puntos_totales || 0) + pts;
              await _supabase.from('equipos_fantasy').update({ puntos_totales: nuevosPuntos }).eq('id', eq.id); 
              alert(`‚úÖ +${pts} a ${eq.nombre_equipo}`); 
          } else { alert("‚úÖ Puntos guardados"); } 
          ['goles','asist','paradas','ama','roja','encajados','recuperaciones'].forEach(k => document.getElementById('stats-'+k).value=0); 
          calcularPuntosEnVivo(); cargarRanking(); 
      }

      // --- RECALCULAR ---
      async function recalcularTodo() {
          if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro?")) return;
          console.log("Iniciando rec√°lculo...");
          await _supabase.from('equipos_fantasy').update({ puntos_totales: 0 }).neq('id', 0);
          const { data: actuaciones } = await _supabase.from('actuaciones').select('*');
          const { data: jugadores } = await _supabase.from('jugadores').select('id, posicion');
          const { data: plantilla } = await _supabase.from('plantilla').select('equipo_id, jugador_id');
          if (!actuaciones || !jugadores || !plantilla) return alert("Error leyendo datos.");

          const mapaPosicion = {}; jugadores.forEach(j => mapaPosicion[j.id] = j.posicion);
          const mapaEquipo = {}; plantilla.forEach(p => mapaEquipo[p.jugador_id] = p.equipo_id);
          const puntosPorEquipo = {};

          for (const acta of actuaciones) {
              const pos = mapaPosicion[acta.jugador_id];
              const nuevosPuntos = calcularFormula(acta, pos);
              await _supabase.from('actuaciones').update({ puntos_calculados: nuevosPuntos }).eq('id', acta.id);
              const eqId = mapaEquipo[acta.jugador_id];
              if (eqId) {
                  if (!puntosPorEquipo[eqId]) puntosPorEquipo[eqId] = 0;
                  puntosPorEquipo[eqId] += nuevosPuntos;
              }
          }
          for (const [eqId, total] of Object.entries(puntosPorEquipo)) {
              const totalRedondeado = Math.round(total * 100) / 100;
              await _supabase.from('equipos_fantasy').update({ puntos_totales: totalRedondeado }).eq('id', eqId);
          }
          alert("‚úÖ Recalculado."); cargarRanking(); cargarEstadisticas();
      }

      // --- MODAL JUGADOR ACTUALIZADO (CON FETCH STATS) ---
      async function abrirModalJugador(id, n, pos, p, f, tit) { 
          jugadorActualId = id; esTitularActual = tit; 
          document.getElementById('modal-nombre').innerText = n; 
          document.getElementById('modal-posicion').innerText = pos; 
          document.getElementById('modal-precio').innerText = (p/1000000).toFixed(1) + " M‚Ç¨"; 
          document.getElementById('modal-foto').src = f; 
          
          // Resetear stats visuales a 0
          ['goles','asist','robos','puntos'].forEach(k => document.getElementById(`modal-stat-${k}`).innerText = "...");

          const b = document.getElementById('btn-titular'); 
          b.innerText = tit ? "‚¨áÔ∏è Banquillo" : "‚¨ÜÔ∏è Titular"; 
          b.onclick = () => cambiarEstado(!tit); 
          document.getElementById('btn-vender').onclick = () => venderJugador(p); 
          const st = document.getElementById('modal-estado'); 
          st.innerText = tit ? "üü¢ TITULAR" : "‚ö™ SUPLENTE"; 
          st.className = tit ? "px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800" : "px-3 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-600"; 
          document.getElementById('modal-jugador').classList.remove('hidden');

          // Fetch Stats
          const { data: acts } = await _supabase.from('actuaciones').select('*').eq('jugador_id', id);
          if(acts) {
              const tG = acts.reduce((s, a) => s + (a.goles || 0), 0);
              const tA = acts.reduce((s, a) => s + (a.asistencias || 0), 0);
              const tR = acts.reduce((s, a) => s + (a.recuperaciones || 0), 0);
              const tP = acts.reduce((s, a) => s + (a.puntos_calculados || 0), 0);
              
              document.getElementById('modal-stat-goles').innerText = tG;
              document.getElementById('modal-stat-asist').innerText = tA;
              document.getElementById('modal-stat-robos').innerText = tR;
              document.getElementById('modal-stat-puntos').innerText = tP.toFixed(1);
          }
      }

      async function cambiarEstado(n) { 
          const { data: { user } } = await _supabase.auth.getUser(); 
          const { data: eq } = await _supabase.from("equipos_fantasy").select("id").eq("usuario_id", user.id).single(); 
          await _supabase.from('plantilla').update({ es_titular: n }).eq('equipo_id', eq.id).eq('jugador_id', jugadorActualId); 
          cerrarModal('modal-jugador'); cargarPlantilla(); 
      }

      async function venderJugador(p) { 
          if(!confirm("¬øVender?")) return; 
          const { data: { user } } = await _supabase.auth.getUser(); 
          const { data: eq } = await _supabase.from("equipos_fantasy").select("id, presupuesto").eq("usuario_id", user.id).single(); 
          await _supabase.from('plantilla').delete().eq('equipo_id', eq.id).eq('jugador_id', jugadorActualId); 
          await _supabase.from('equipos_fantasy').update({ presupuesto: eq.presupuesto + p }).eq('id', eq.id); 
          cerrarModal('modal-jugador'); cargarPlantilla(); 
      }

      async function crearEquipoNuevo() { 
          const n = prompt("Nombre:"); if(n) { 
              const { data: { user } } = await _supabase.auth.getUser(); 
              await _supabase.from('equipos_fantasy').insert({ usuario_id: user.id, nombre_equipo: n, presupuesto: 200000000, puntos_totales: 0 }); 
              cargarPlantilla(); 
          } 
      }
      async function logout() { await _supabase.auth.signOut(); window.location.href = "index.html"; }
      
      async function cargarOfertasRecibidas(eqId) { 
          const box = document.getElementById('buzon-ofertas'); 
          const list = document.getElementById('lista-ofertas'); 
          list.innerHTML = '';
          try {
              const { data: pl } = await _supabase.from('plantilla').select('jugador_id').eq('equipo_id', eqId);
              if(!pl || !pl.length) return; 
              const ids = pl.map(x => x.jugador_id); 
              const { data: ofs } = await _supabase.from('pujas').select('id, monto, equipo_id, jugador_id').in('jugador_id', ids); 
              if(!ofs || !ofs.length) { box.classList.add('hidden'); return; } 
              box.classList.remove('hidden'); 
              for(const o of ofs) { 
                  const { data: riv } = await _supabase.from('equipos_fantasy').select('nombre_equipo').eq('id', o.equipo_id).single(); 
                  const { data: jug } = await _supabase.from('jugadores').select('nombre').eq('id', o.jugador_id).single(); 
                  list.innerHTML += `<div class="bg-white p-2 border flex justify-between"><div><p class="text-sm font-bold">Oferta por ${jug.nombre}</p><p class="text-xs">De: ${riv.nombre_equipo}</p></div><div class="flex gap-2 items-center"><span class="font-bold text-green-600">${(o.monto/1000000).toFixed(1)}M</span><button onclick="gestionarOferta(${o.id},true)" class="bg-green-500 text-white px-2 rounded">OK</button><button onclick="gestionarOferta(${o.id},false)" class="bg-red-500 text-white px-2 rounded">X</button></div></div>`; 
              }
          } catch(e) { console.log(e); }
      }

      async function gestionarOferta(id, ok) { 
          if(!ok) { await _supabase.from('pujas').delete().eq('id', id); cargarPlantilla(); return; } 
          if(!confirm("¬øAceptar?")) return; 
          const { data: p } = await _supabase.from('pujas').select('*').eq('id', id).single(); 
          const { data: comp } = await _supabase.from('equipos_fantasy').select('id, presupuesto').eq('id', p.equipo_id).single(); 
          const { data: { user } } = await _supabase.auth.getUser(); 
          const { data: yo } = await _supabase.from('equipos_fantasy').select('id, presupuesto').eq('usuario_id', user.id).single(); 
          if(comp.presupuesto < p.monto) return alert("Sin fondos"); 
          await _supabase.from('equipos_fantasy').update({ presupuesto: comp.presupuesto - p.monto }).eq('id', comp.id); 
          await _supabase.from('equipos_fantasy').update({ presupuesto: yo.presupuesto + p.monto }).eq('id', yo.id); 
          await _supabase.from('plantilla').delete().match({ equipo_id: yo.id, jugador_id: p.jugador_id }); 
          await _supabase.from('plantilla').insert({ equipo_id: comp.id, jugador_id: p.jugador_id, es_titular: false }); 
          await _supabase.from('pujas').delete().eq('jugador_id', p.jugador_id); 
          alert("Vendido!"); cargarPlantilla(); 
      }

      // --- 11. CARGAR PLANTILLA PROPIA ---
      async function cargarPlantilla() { 
          // 1. Obtener Usuario
          const { data: { user } } = await _supabase.auth.getUser();
          if (!user) return;

          // 2. Obtener Mi Equipo
          const { data: miEquipo, error: errorEquipo } = await _supabase
              .from("equipos_fantasy")
              .select("id, presupuesto")
              .eq("usuario_id", user.id)
              .maybeSingle();

          if (errorEquipo) {
              console.error("Error buscando equipo:", errorEquipo);
              alert("Error de conexi√≥n: " + errorEquipo.message);
              return;
          }

          // Si no tiene equipo, mostrar bot√≥n de crear
          if (!miEquipo) {
              document.getElementById('campo-titulares').innerHTML = `
                  <div class="text-center mt-10">
                      <p class="text-white mb-4">No tienes equipo todav√≠a.</p>
                      <button onclick="crearEquipoNuevo()" class="bg-white text-green-700 px-6 py-3 rounded-full font-bold shadow-lg transform hover:scale-105 transition">
                          ‚ú® Crear Equipo Ahora
                      </button>
                  </div>`;
              document.getElementById('valor-plantilla').innerText = "0 M‚Ç¨";
              return; 
          }

          // 3. Cargar Buz√≥n (Ofertas)
          await cargarOfertasRecibidas(miEquipo.id);

          // 4. Cargar Jugadores (Plantilla)
          try {
              const { data: plantilla, error: errorPlantilla } = await _supabase
                  .from("plantilla")
                  .select(`
                      es_titular, 
                      jugadores (
                          id, nombre, posicion, precio, precio_anterior, foto_url
                      )
                  `)
                  .eq("equipo_id", miEquipo.id);

              if (errorPlantilla) throw errorPlantilla;

              // Calcular Valor y Separar
              let valorTotal = 0;
              const titulares = [];
              const suplentes = [];

              if (plantilla && plantilla.length > 0) {
                  plantilla.forEach(p => {
                      if(p.jugadores) {
                          valorTotal += p.jugadores.precio;
                          if(p.es_titular) titulares.push(p);
                          else suplentes.push(p);
                      }
                  });
              }

              // Ordenar
              titulares.sort((a, b) => ordenPos(a.jugadores.posicion) - ordenPos(b.jugadores.posicion));
              suplentes.sort((a, b) => ordenPos(a.jugadores.posicion) - ordenPos(b.jugadores.posicion));

              // Render
              const render = (p, esTit) => {
                  const j = p.jugadores;
                  const badge = generarBadgePrecio(j.precio, j.precio_anterior);
                  const nombreSafe = j.nombre.replace(/'/g, "\\'");
                  const foto = j.foto_url || "https://via.placeholder.com/150";
                  const datosJugador = `abrirModalJugador(${j.id}, '${nombreSafe}', '${j.posicion}', ${j.precio}, '${foto}', ${esTit})`;
                  
                  return `
                      <div onclick="${datosJugador}" class="mx-auto w-full transform hover:scale-105 transition cursor-pointer flex items-center bg-white/95 backdrop-blur-sm rounded-lg p-3 shadow-lg border-l-4 ${getColorBorde(j.posicion)}">
                          <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden mr-3 border border-gray-300">
                              <img src="${foto}" class="w-full h-full object-cover">
                          </div>
                          <div class="flex-1 flex justify-between items-center">
                              <div>
                                  <p class="text-[10px] font-bold text-gray-500 uppercase">${j.posicion}</p>
                                  <div class="flex items-center">
                                      <h4 class="font-bold text-gray-900 leading-none text-sm">${j.nombre}</h4>
                                      ${badge}
                                  </div>
                              </div>
                              <div class="text-right">
                                  <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded-full font-bold border">
                                      ${esTit ? "TITULAR" : "BANCA"}
                                  </span>
                              </div>
                          </div>
                      </div>`;
              };

              const htmlTitulares = titulares.length ? titulares.map(p => render(p, true)).join('') : '<p class="text-white text-center italic opacity-70">Alineaci√≥n vac√≠a</p>';
              const htmlSuplentes = suplentes.length ? suplentes.map(p => render(p, false)).join('') : '<p class="text-gray-400 text-center text-sm italic">Banquillo vac√≠o</p>';

              document.getElementById("campo-titulares").innerHTML = htmlTitulares;
              document.getElementById("grid-suplentes").innerHTML = htmlSuplentes;
              document.getElementById("valor-plantilla").innerText = (valorTotal / 1000000).toFixed(1) + " M‚Ç¨";

          } catch (err) {
              console.error("Error cr√≠tico cargando plantilla:", err);
              document.getElementById("campo-titulares").innerHTML = `<p class="text-red-300 text-center bg-red-900/50 p-2 rounded">Error: ${err.message}</p>`;
          }
      }
    </script>
  </body>
</html>
